<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Register for EMPOWER SAFE">
  <title>Register - EMPOWER SAFE</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <nav class="navbar">
    <div class="navbar-content">
      <a href="/" class="navbar-brand">üõ°Ô∏è EMPOWER SAFE</a>
      <button class="navbar-toggle">‚ò∞</button>
    </div>
  </nav>

  <div class="page">
    <div class="page-content">
      <div class="container-sm">
        <div style="text-align: center; margin-bottom: var(--spacing-2xl);">
          <h1>Create Your Account</h1>
          <p>Join thousands of women staying safe with EMPOWER SAFE</p>
        </div>

        <div class="card">
          <form id="registerForm" style="display: grid; gap: var(--spacing-lg);">
            <!-- Step 1: Basic Info -->
            <div id="step1">
              <h3 style="margin-bottom: var(--spacing-lg);">Personal Information</h3>

              <div class="form-group">
                <label for="name">Full Name</label>
                <input type="text" id="name" name="name" required placeholder="Your full name">
              </div>

              <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" required placeholder="you@example.com">
              </div>

              <div class="form-group">
                <label for="phone">Phone Number</label>
                <input type="tel" id="phone" name="phone" required placeholder="+91 98765 43210">
              </div>

              <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" required placeholder="Min 8 characters">
                <small style="color: var(--text-light); display: block; margin-top: var(--spacing-xs);">
                  Use at least 8 characters with uppercase, lowercase, and numbers.
                </small>
              </div>

              <div class="form-group">
                <label for="confirmPassword">Confirm Password</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Confirm password">
              </div>

              <div id="alerts"></div>

              <button type="button" class="btn btn-primary btn-lg" id="nextBtn" style="width: 100%;">Next: Add Contacts</button>
            </div>

            <!-- Step 2: Emergency Contacts -->
            <div id="step2" class="hidden">
              <h3 style="margin-bottom: var(--spacing-lg);">Emergency Contacts</h3>
              <p class="text-muted">Add at least 2 trusted contacts who will be alerted in emergencies.</p>

              <div id="contactsList"></div>

              <button type="button" class="btn btn-ghost" id="addContactBtn" style="width: 100%; margin-bottom: var(--spacing-lg);">+ Add Contact</button>

              <div id="alertsStep2"></div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                <button type="button" class="btn btn-secondary btn-lg" id="backBtn">Back</button>
                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                  <span id="submitText">Create Account</span>
                  <span id="submitLoader" class="hidden" style="margin-left: var(--spacing-sm);">
                    <span class="spinner"></span>
                  </span>
                </button>
              </div>
            </div>
          </form>

          <div style="text-align: center; margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 1px solid var(--border);">
            <p>Already have an account? <a href="/login.html"><strong>Sign in</strong></a></p>
          </div>
        </div>
      </div>
    </div>

    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <p>&copy; 2026 EMPOWER SAFE. All rights reserved.</p>
        </div>
      </div>
    </footer>
  </div>

  <!-- Contact Modal -->
  <div id="contactModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h4>Add Emergency Contact</h4>
        <button class="modal-close" type="button" aria-label="Close">√ó</button>
      </div>
      <form id="contactForm">
        <div class="form-group">
          <label for="contactName">Name</label>
          <input type="text" id="contactName" required placeholder="Contact name">
        </div>
        <div class="form-group">
          <label for="contactRelation">Relation</label>
          <select id="contactRelation" required>
            <option value="">Select relation</option>
            <option value="Mother">Mother</option>
            <option value="Father">Father</option>
            <option value="Sister">Sister</option>
            <option value="Brother">Brother</option>
            <option value="Spouse">Spouse</option>
            <option value="Friend">Friend</option>
            <option value="Colleague">Colleague</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label for="contactPhone">Phone Number</label>
          <input type="tel" id="contactPhone" required placeholder="+91 98765 43210">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-ghost" onclick="UI.closeModal('contactModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Contact</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/app.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      Auth.redirectToDashboard();

      const form = DOM.get('#registerForm');
      const step1 = DOM.get('#step1');
      const step2 = DOM.get('#step2');
      const nextBtn = DOM.get('#nextBtn');
      const backBtn = DOM.get('#backBtn');
      const submitBtn = DOM.get('#submitBtn');
      const addContactBtn = DOM.get('#addContactBtn');
      const contactsList = DOM.get('#contactsList');
      const contactModal = DOM.get('#contactModal');
      const contactForm = DOM.get('#contactForm');
      const modalClose = contactModal.querySelector('.modal-close');

      const nameInput = DOM.get('#name');
      const emailInput = DOM.get('#email');
      const phoneInput = DOM.get('#phone');
      const passwordInput = DOM.get('#password');
      const confirmPasswordInput = DOM.get('#confirmPassword');
      const alerts = DOM.get('#alerts');
      const alertsStep2 = DOM.get('#alertsStep2');

      let contacts = [];

      // Validators
      const validateStep1 = () => {
        let isValid = true;

        if (!Validator.required(nameInput.value)) {
          Validator.showError(nameInput, 'Name is required');
          isValid = false;
        } else {
          Validator.clearError(nameInput);
        }

        if (!Validator.email(emailInput.value)) {
          Validator.showError(emailInput, 'Valid email is required');
          isValid = false;
        } else {
          Validator.clearError(emailInput);
        }

        if (!Validator.phone(phoneInput.value)) {
          Validator.showError(phoneInput, 'Valid phone number is required');
          isValid = false;
        } else {
          Validator.clearError(phoneInput);
        }

        if (!Validator.password(passwordInput.value)) {
          Validator.showError(passwordInput, 'Password must be at least 8 characters');
          isValid = false;
        } else {
          Validator.clearError(passwordInput);
        }

        if (passwordInput.value !== confirmPasswordInput.value) {
          Validator.showError(confirmPasswordInput, 'Passwords do not match');
          isValid = false;
        } else {
          Validator.clearError(confirmPasswordInput);
        }

        return isValid;
      };

      const validateStep2 = () => {
        if (contacts.length < 2) {
          UI.showError('Please add at least 2 emergency contacts', alertsStep2);
          return false;
        }
        return true;
      };

      // Modal handlers
      DOM.on(addContactBtn, 'click', () => UI.openModal('contactModal'));
      DOM.on(modalClose, 'click', () => UI.closeModal('contactModal'));

      DOM.on(contactModal, 'click', (e) => {
        if (e.target === contactModal) UI.closeModal('contactModal');
      });

      // Add contact
      DOM.on(contactForm, 'submit', (e) => {
        e.preventDefault();
        const contact = {
          id: Date.now(),
          name: DOM.get('#contactName').value,
          relation: DOM.get('#contactRelation').value,
          phone: DOM.get('#contactPhone').value,
        };

        contacts.push(contact);
        renderContacts();
        contactForm.reset();
        UI.closeModal('contactModal');
        UI.showSuccess('Contact added successfully', alertsStep2);
      });

      const renderContacts = () => {
        contactsList.innerHTML = '';
        contacts.forEach((contact) => {
          const item = DOM.createElement('div', 'card mt-md');
          item.innerHTML = `
            <div class="flex-between">
              <div>
                <h4 style="margin: 0 0 var(--spacing-xs) 0;">${contact.name}</h4>
                <small style="color: var(--text-light);">${contact.relation} ¬∑ ${contact.phone}</small>
              </div>
              <button type="button" class="btn btn-danger btn-sm" onclick="removeContact(${contact.id})">Remove</button>
            </div>
          `;
          contactsList.appendChild(item);
        });
      };

      window.removeContact = (id) => {
        contacts = contacts.filter((c) => c.id !== id);
        renderContacts();
        UI.showInfo('Contact removed', alertsStep2);
      };

      // Navigation
      DOM.on(nextBtn, 'click', (e) => {
        e.preventDefault();
        if (validateStep1()) {
          DOM.hide(step1);
          DOM.show(step2);
        }
      });

      DOM.on(backBtn, 'click', (e) => {
        e.preventDefault();
        DOM.show(step1);
        DOM.hide(step2);
      });

      // Form submission
      DOM.on(form, 'submit', async (e) => {
        e.preventDefault();

        if (!validateStep2()) return;

        try {
          DOM.setAttr(submitBtn, 'disabled', '');
          DOM.hide(DOM.get('#submitText'));
          DOM.show(DOM.get('#submitLoader'));

          const response = await api.register(
            emailInput.value,
            phoneInput.value,
            passwordInput.value,
            nameInput.value,
            contacts
          );

          Auth.setUser(response.user);
          api.setToken(response.token);

          UI.showSuccess('Account created! Redirecting to dashboard...', alertsStep2);

          await delay(1500);
          window.location.href = '/dashboard.html';
        } catch (error) {
          UI.showError(error.message || 'Registration failed', alertsStep2);
        } finally {
          DOM.removeAttr(submitBtn, 'disabled');
          DOM.show(DOM.get('#submitText'));
          DOM.hide(DOM.get('#submitLoader'));
        }
      });
    });
  </script>
</body>
</html>
