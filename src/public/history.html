<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Incident History - EMPOWER SAFE">
  <title>History - EMPOWER SAFE</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="navbar-content">
      <a href="/" class="navbar-brand">üõ°Ô∏è EMPOWER SAFE</a>
      <ul class="navbar-menu">
        <li><a href="/dashboard.html">Home</a></li>
        <li><a href="/contacts.html">Contacts</a></li>
        <li><a href="/profile.html">Profile</a></li>
        <li><a href="/history.html">History</a></li>
        <li><button id="logoutBtn" class="btn btn-sm btn-danger">Logout</button></li>
      </ul>
      <button class="navbar-toggle">‚ò∞</button>
    </div>
  </nav>

  <div class="page">
    <div class="page-content">
      <div class="container">
        <h1 style="margin-top: var(--spacing-2xl);">Incident History</h1>
        <p class="text-muted">Track all your emergency SOS events and their status</p>

        <!-- Filters -->
        <div class="card mt-lg">
          <div class="grid grid-3">
            <div class="form-group" style="margin: 0;">
              <label for="filterStatus">Status</label>
              <select id="filterStatus">
                <option value="">All Status</option>
                <option value="pending">Pending</option>
                <option value="acknowledged">Acknowledged</option>
                <option value="resolved">Resolved</option>
              </select>
            </div>

            <div class="form-group" style="margin: 0;">
              <label for="filterDate">Date Range</label>
              <select id="filterDate">
                <option value="">All Time</option>
                <option value="today">Today</option>
                <option value="week">Last 7 Days</option>
                <option value="month">Last 30 Days</option>
              </select>
            </div>

            <div style="display: flex; align-items: flex-end; gap: var(--spacing-sm);">
              <button id="filterBtn" class="btn btn-primary" style="flex: 1;">Apply Filters</button>
              <button id="resetBtn" class="btn btn-ghost" style="flex: 1;">Reset</button>
            </div>
          </div>
        </div>

        <!-- Incidents List -->
        <div id="incidentsList" class="card mt-lg">
          <div class="text-center text-muted" style="padding: var(--spacing-lg);">
            <p style="margin: 0;">Loading incidents...</p>
          </div>
        </div>

        <div id="alerts"></div>
      </div>
    </div>

    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <p>&copy; 2026 EMPOWER SAFE. All rights reserved.</p>
        </div>
      </div>
    </footer>
  </div>

  <!-- Incident Detail Modal -->
  <div id="detailModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h4 id="detailTitle">Incident Details</h4>
        <button class="modal-close" type="button" aria-label="Close">√ó</button>
      </div>

      <div id="detailContent"></div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="UI.closeModal('detailModal')">Close</button>
      </div>
    </div>
  </div>

  <script src="/app.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      Auth.redirectToLogin();

      const incidentsList = DOM.get('#incidentsList');
      const alerts = DOM.get('#alerts');
      const logoutBtn = DOM.get('#logoutBtn');
      const filterBtn = DOM.get('#filterBtn');
      const resetBtn = DOM.get('#resetBtn');
      const filterStatus = DOM.get('#filterStatus');
      const filterDate = DOM.get('#filterDate');
      const detailModal = DOM.get('#detailModal');
      const modalClose = detailModal.querySelector('.modal-close');

      let allIncidents = [];

      // Load incidents
      const loadIncidents = async () => {
        try {
          allIncidents = await api.getIncidents();
          renderIncidents(allIncidents);
        } catch (error) {
          UI.showError('Failed to load incidents', alerts);
        }
      };

      // Render incidents
      const renderIncidents = (incidents) => {
        incidentsList.innerHTML = '';

        if (!incidents || incidents.length === 0) {
          incidentsList.innerHTML = `
            <div class="text-center" style="padding: var(--spacing-2xl);">
              <div style="font-size: 3rem; margin-bottom: var(--spacing-lg);">üìã</div>
              <h3>No incidents yet</h3>
              <p class="text-muted">When you trigger SOS, incidents will appear here.</p>
            </div>
          `;
          return;
        }

        const list = DOM.createElement('ul', 'list');
        incidents.forEach((incident) => {
          const date = new Date(incident.createdAt);
          const statusBadge = getStatusBadge(incident.status);

          const item = DOM.createElement('li', 'list-item');
          item.innerHTML = `
            <div class="list-item-header">
              <div style="flex: 1;">
                <h4 style="margin: 0 0 var(--spacing-xs) 0;">${incident.message || 'SOS Alert'}</h4>
                <small style="color: var(--text-light);">
                  ${date.toLocaleString()} 
                </small>
              </div>
              <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                ${statusBadge}
                <button type="button" class="btn btn-ghost btn-sm" onclick="viewDetails('${incident._id}')">View</button>
              </div>
            </div>
          `;
          list.appendChild(item);
        });
        incidentsList.innerHTML = '';
        incidentsList.appendChild(list);
      };

      // Get status badge
      const getStatusBadge = (status) => {
        const badges = {
          pending: '<span class="badge badge-warning">Pending</span>',
          acknowledged: '<span class="badge badge-primary">Acknowledged</span>',
          resolved: '<span class="badge badge-success">Resolved</span>',
        };
        return badges[status] || '<span class="badge">Unknown</span>';
      };

      // View incident details
      window.viewDetails = async (incidentId) => {
        try {
          const incident = await api.getIncident(incidentId);
          const date = new Date(incident.createdAt);

          const content = DOM.get('#detailContent');
          content.innerHTML = `
            <div style="display: grid; gap: var(--spacing-lg);">
              <div>
                <h4 style="margin: 0 0 var(--spacing-xs) 0;">Message</h4>
                <p style="margin: 0;">${incident.message || 'Emergency SOS Alert'}</p>
              </div>

              <div class="grid grid-2">
                <div>
                  <h4 style="margin: 0 0 var(--spacing-xs) 0;">Date & Time</h4>
                  <p style="margin: 0; font-size: 0.875rem;">${date.toLocaleString()}</p>
                </div>
                <div>
                  <h4 style="margin: 0 0 var(--spacing-xs) 0;">Status</h4>
                  <p style="margin: 0; font-size: 0.875rem;">${getStatusBadge(incident.status)}</p>
                </div>
              </div>

              ${
                incident.location
                  ? `
                <div>
                  <h4 style="margin: 0 0 var(--spacing-xs) 0;">Location</h4>
                  <p style="margin: 0; font-size: 0.875rem;">
                    üìç ${incident.location.address || `${incident.location.lat}, ${incident.location.lng}`}
                  </p>
                </div>
              `
                  : ''
              }

              ${
                incident.metadata
                  ? `
                <div>
                  <h4 style="margin: 0 0 var(--spacing-xs) 0;">Additional Info</h4>
                  <pre style="background: var(--bg); padding: var(--spacing-md); border-radius: 8px; font-size: 0.75rem; overflow-x: auto; margin: 0;">${JSON.stringify(
                    incident.metadata,
                    null,
                    2
                  )}</pre>
                </div>
              `
                  : ''
              }
            </div>
          `;

          UI.openModal('detailModal');
        } catch (error) {
          UI.showError('Failed to load incident details', alerts);
        }
      };

      // Filter logic
      const applyFilters = () => {
        let filtered = allIncidents;

        const status = filterStatus.value;
        const dateRange = filterDate.value;

        if (status) {
          filtered = filtered.filter((i) => i.status === status);
        }

        if (dateRange) {
          const now = new Date();
          let startDate = new Date();

          if (dateRange === 'today') {
            startDate.setHours(0, 0, 0, 0);
          } else if (dateRange === 'week') {
            startDate.setDate(now.getDate() - 7);
          } else if (dateRange === 'month') {
            startDate.setDate(now.getDate() - 30);
          }

          filtered = filtered.filter(
            (i) => new Date(i.createdAt) >= startDate && new Date(i.createdAt) <= now
          );
        }

        renderIncidents(filtered);
      };

      // Filter events
      DOM.on(filterBtn, 'click', applyFilters);
      DOM.on(resetBtn, 'click', () => {
        filterStatus.value = '';
        filterDate.value = '';
        renderIncidents(allIncidents);
      });

      // Modal close
      DOM.on(modalClose, 'click', () => UI.closeModal('detailModal'));
      DOM.on(detailModal, 'click', (e) => {
        if (e.target === detailModal) UI.closeModal('detailModal');
      });

      // Logout
      DOM.on(logoutBtn, 'click', () => {
        if (UI.showConfirm('Are you sure you want to logout?')) {
          Auth.logout();
        }
      });

      loadIncidents();
    });
  </script>
</body>
</html>
