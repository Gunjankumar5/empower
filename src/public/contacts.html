<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Emergency Contacts - EMPOWER SAFE">
  <title>Contacts - EMPOWER SAFE</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="navbar-content">
      <a href="/" class="navbar-brand">üõ°Ô∏è EMPOWER SAFE</a>
      <ul class="navbar-menu">
        <li><a href="/dashboard.html">Home</a></li>
        <li><a href="/contacts.html">Contacts</a></li>
        <li><a href="/profile.html">Profile</a></li>
        <li><a href="/history.html">History</a></li>
        <li><button id="logoutBtn" class="btn btn-sm btn-danger">Logout</button></li>
      </ul>
      <button class="navbar-toggle">‚ò∞</button>
    </div>
  </nav>

  <div class="page">
    <div class="page-content">
      <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: var(--spacing-2xl); margin-bottom: var(--spacing-lg);">
          <h1>Emergency Contacts</h1>
          <button id="addContactBtn" class="btn btn-primary">+ Add Contact</button>
        </div>

        <div class="alert alert-info">
          <strong>üí° Tip:</strong> Add at least 2-3 trusted contacts. They will be immediately notified when you trigger SOS.
        </div>

        <div id="contactsList" class="card">
          <div class="text-center text-muted" style="padding: var(--spacing-lg);">
            <p style="margin: 0;">Loading contacts...</p>
          </div>
        </div>

        <div id="alerts"></div>
      </div>
    </div>

    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <p>&copy; 2026 EMPOWER SAFE. All rights reserved.</p>
        </div>
      </div>
    </footer>
  </div>

  <!-- Add Contact Modal -->
  <div id="addContactModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h4>Add Emergency Contact</h4>
        <button class="modal-close" type="button" aria-label="Close">√ó</button>
      </div>
      <form id="contactForm">
        <div class="form-group">
          <label for="contactName">Name</label>
          <input type="text" id="contactName" required placeholder="Contact full name">
        </div>
        <div class="form-group">
          <label for="contactRelation">Relation</label>
          <select id="contactRelation" required>
            <option value="">Select relation</option>
            <option value="Mother">Mother</option>
            <option value="Father">Father</option>
            <option value="Sister">Sister</option>
            <option value="Brother">Brother</option>
            <option value="Spouse">Spouse</option>
            <option value="Friend">Friend</option>
            <option value="Colleague">Colleague</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label for="contactPhone">Phone Number</label>
          <input type="tel" id="contactPhone" required placeholder="+91 98765 43210">
        </div>
        <div id="modalAlerts"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="UI.closeModal('addContactModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <span id="formText">Add Contact</span>
            <span id="formLoader" class="hidden" style="margin-left: var(--spacing-sm);">
              <span class="spinner"></span>
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="/app.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      Auth.redirectToLogin();

      const addContactBtn = DOM.get('#addContactBtn');
      const contactsList = DOM.get('#contactsList');
      const addContactModal = DOM.get('#addContactModal');
      const contactForm = DOM.get('#contactForm');
      const modalClose = addContactModal.querySelector('.modal-close');
      const alerts = DOM.get('#alerts');
      const modalAlerts = DOM.get('#modalAlerts');
      const logoutBtn = DOM.get('#logoutBtn');

      // Load contacts
      const loadContacts = async () => {
        try {
          const profile = await api.getUserProfile();
          renderContacts(profile.contacts || []);
        } catch (error) {
          UI.showError('Failed to load contacts', alerts);
        }
      };

      // Render contacts
      const renderContacts = (contacts) => {
        contactsList.innerHTML = '';

        if (!contacts || contacts.length === 0) {
          contactsList.innerHTML = `
            <div class="text-center" style="padding: var(--spacing-2xl);">
              <div style="font-size: 3rem; margin-bottom: var(--spacing-lg);">üë•</div>
              <h3>No contacts yet</h3>
              <p class="text-muted">Add your first emergency contact to get started.</p>
              <button onclick="DOM.get('#addContactBtn').click()" class="btn btn-primary mt-lg">Add Contact</button>
            </div>
          `;
          return;
        }

        const list = DOM.createElement('ul', 'list');
        contacts.forEach((contact) => {
          const item = DOM.createElement('li', 'list-item');
          item.innerHTML = `
            <div class="list-item-header">
              <div>
                <h4 style="margin: 0 0 var(--spacing-xs) 0;">${contact.name}</h4>
                <small style="color: var(--text-light);">${contact.relation} ¬∑ ${contact.phone}</small>
              </div>
              <div class="list-item-actions">
                <button type="button" class="btn btn-ghost btn-sm" onclick="editContact('${contact._id}')">Edit</button>
                <button type="button" class="btn btn-danger btn-sm" onclick="deleteContact('${contact._id}')">Delete</button>
              </div>
            </div>
          `;
          list.appendChild(item);
        });
        contactsList.innerHTML = '';
        contactsList.appendChild(list);
      };

      // Add contact modal
      DOM.on(addContactBtn, 'click', () => UI.openModal('addContactModal'));
      DOM.on(modalClose, 'click', () => UI.closeModal('addContactModal'));

      DOM.on(addContactModal, 'click', (e) => {
        if (e.target === addContactModal) UI.closeModal('addContactModal');
      });

      // Form submission
      DOM.on(contactForm, 'submit', async (e) => {
        e.preventDefault();

        const name = DOM.get('#contactName').value.trim();
        const relation = DOM.get('#contactRelation').value;
        const phone = DOM.get('#contactPhone').value.trim();

        if (!Validator.phone(phone)) {
          UI.showError('Please enter a valid phone number', modalAlerts);
          return;
        }

        try {
          const submitBtn = contactForm.querySelector('button[type="submit"]');
          DOM.setAttr(submitBtn, 'disabled', '');
          DOM.hide(DOM.get('#formText'));
          DOM.show(DOM.get('#formLoader'));

          await api.addContact(name, relation, phone);

          UI.showSuccess('Contact added successfully!', alerts);
          contactForm.reset();
          UI.closeModal('addContactModal');
          loadContacts();
        } catch (error) {
          UI.showError(error.message || 'Failed to add contact', modalAlerts);
        } finally {
          const submitBtn = contactForm.querySelector('button[type="submit"]');
          DOM.removeAttr(submitBtn, 'disabled');
          DOM.show(DOM.get('#formText'));
          DOM.hide(DOM.get('#formLoader'));
        }
      });

      // Delete contact
      window.deleteContact = async (contactId) => {
        if (!UI.showConfirm('Are you sure you want to delete this contact?')) return;

        try {
          await api.deleteContact(contactId);
          UI.showSuccess('Contact deleted', alerts);
          loadContacts();
        } catch (error) {
          UI.showError(error.message || 'Failed to delete contact', alerts);
        }
      };

      // Logout
      DOM.on(logoutBtn, 'click', () => {
        if (UI.showConfirm('Are you sure you want to logout?')) {
          Auth.logout();
        }
      });

      // Initial load
      loadContacts();
    });
  </script>
</body>
</html>
